# 记录 vim 的使用笔记

# 把外部shell命令的执行结果写入到vim中
在 vim 中，可以使用 `:r !cmd` 命令执行 shell 中的 cmd 命令，并把该命令的打印结果写入到当前光标的下一行。

例如，`:r !date` 命令执行 shell 的 `date` 命令，打印当前的时间，把这个打印结果写入到当前光标的下一行。

也可以在 `r` 命令的前面加上数字指定要写入到哪一行之后，而不是写入到当前光标的下一行。

例如，`:2r !date` 命令是把打印结果写入到第二行的后面，也就是写入到第三行，原先第三行会挪到第四行，后面的内容依此类推。

**注意**：如果不加感叹号 `!`，那么后面跟着的参数会被认为是文件名，如果存在该文件，会读取该文件内容，写入到当前光标的下一行。如果该文件不存在，则报错提示找不到文件。例如， `:r date` 命令是读取名为 *date* 的文件内容，写入到当前光标的下一行。

这里的 `:r` 是 `:read` 命令的缩写。

在 vim 中，用 `:help :r` 命令查看 `:r !cmd` 和 `:r name` 命令的帮助说明。部分关键说明如下：
> **:r[ead] [++opt] [name]**  
Insert the file [name] (default: current file) below the cursor.

> **:{range}r[ead] [++opt] [name]**  
Insert the file [name] (default: current file) below the specified line.

> **:[range]r[ead] !{cmd}**  
Execute {cmd} and insert its standard output below the cursor or the specified line.

# 删除包含特定字符的行
在 vim 中，可以使用 `:g/pattern/d` 命令删除所有包含 *pattern* 模式的行。  
例如，删除所有以大写字母 *D* 开头的行，可以执行 `:g/^D/d` 命令。这里的 `^` 表示匹配行首。

这里的 `:g` 是 `:global` 命令的缩写，用 `:help :g` 命令查看它的帮助说明。部分关键说明如下：
> **:[range]g[lobal]/{pattern}/[cmd]**  
  Execute the Ex command [cmd] (default ":p") on the lines within [range] where {pattern} matches.

即，`:global` 命令对匹配特定模式的每一行都执行所给的命令，有效的命令是vim命令行支持的命令，也就是以冒号 `:` 开头的命令，但是输入的时候不需要提供冒号。所以，上面的 *d* 对应 `:d` 命令，表示删除一行。

使用 `:help usr_10.txt` 命令查看该用户手册，在 “10.4 The global command” 小节中对 `:global` 命令也有描述，可以参考。

# 删除重复行，并对所有内容重新排序
在 vim 中，可以执行 `:sort u` 命令删除重复行，只保留一行，并会对所有内容重新排序。  
例如在文件中有如下的内容：
```
debug
checkout
release
hello.c
hello.c
release
hello.c
debug
```
执行 `:sort u` 命令后，会变成下面的内容：
```
checkout
debug
hello.c
release
```
可以看到，去掉了相同内容的重复行，只保留一行，所有行按照字母顺序升序排列。  
在 *sort* 后面加上感叹号 `!` 会按照字母顺序降序排序，也就是逆序。例如 `:sort! u` 命令。

使用 `:help :sort` 命令查看该命令的帮助说明，部分关键内容说明如下：
> **:[range]sor[t][!] [i][u][r][n][x][o] [/{pattern}/]**  
  Sort lines in [range].  When no range is given all lines are sorted.  
  With [!] the order is reversed.  
  With [u] only keep the first of a sequence of identical lines (ignoring case when [i] is used). Without this flag, a sequence of identical lines will be kept in their original order. Note that leading and trailing white space may cause lines to be different.

即，`:sort` 命令本身对文件行进行排序，默认不会去掉重复行，加上 `u` 参数来去掉重复行。

# 删除行首、行末的空白字符 (空格和Tab字符)
在 vim 中，**可以使用 `:%s/^\s\+//` 命令删除行首的所有空白字符**。这里说的 “空白字符” 指的是空格和Tab字符，不包括换行符。对该命令的各个参数具体说明如下：
- `:%s`  
`:s` 是替换命令，可以替换字符串，其基本格式是 `:s/from/to/`，把 "from" 字符串替换成 "to" 字符串，可以用正则表达式来匹配特定模式。该命令默认对光标所在行生效，而 `:%s` 表示对整个文件都进行替换。
- `^`  
表示匹配行首，即从行首开始匹配。对这个例子来说，只匹配行首的空白字符，不会匹配单词中间的空白字符和行末的空白字符。
- `\s`  
表示匹配一个空白字符，也就是空格或Tab字符。
- `\+`  
表示匹配一个或连续多个跟在它前面的上一个字符，其实是正则表达式`+`元字符的转义写法。例如，`a\+` 表示匹配 "a", "aa", "aaaaaa" 等等，`\s\+` 就是匹配一个或多个空白字符，至少要有一个空白字符。
- `/^\s\+//`  
表示要匹配的内容是行首开头的一个或多个空白字符，最后的两个`//`中间内容为空，即替换后的内容为空，相当于去掉了行首的所有空白字符。

也可以使用 `:%s/^\s*//` 命令来删除行首的所有空白字符，`*` 表示匹配零个或连续多个跟在它前面的上一个字符。这个命令会匹配到行首没有空格的情况，由于替换后的内容是空，没有影响。

**注意**：如果写成 `%s/^\s//` 的形式，只会删除行首的第一个空格，而不能删除多个空格。 写成 `%s/^\+\s//` 的形式也是只能删除行首的第一个空格。

**类似的，可以用 `%s/\s\+$//` 命令来删除行末的所有空白字符，`$` 表示匹配行末**。也可以写成 `%s/\s*$//` 的形式。

使用 `:help :s` 命令查看该命令的帮助说明，部分关键内容说明如下：
> **:[range]s[ubstitute]/{pattern}/{string}/[flags] [count]**  
For each line in [range] replace a match of {pattern} with {string}.  
When [range] and [count] are omitted, replace in the current line only.

使用 `:help \s` 命令查看 `\s` 的含义如下：
> **\s**  whitespace character: \<Space\> and \<Tab\>

使用 `:help \+` 命令查看 `\+` 的含义如下：
> **\\+**	Matches 1 or more of the preceding atom, as many as possible.

使用 `:help /*` 命令查看在模式匹配中 `*` 的含义如下：
> \*	(use \\* when 'magic' is not set)  
Matches 0 or more of the preceding atom, as many as possible.

# 删除空白行
空白行指的是看起来没有内容的行，但实际上可能会有空格、Tab字符，或者行末的换行符。针对下面几种情况，需要用不同的命令来删除空白行：
- 删除只有一个换行符的空行
- 删除包含空白字符的空白行，但不删除只有一个换行符的空行
- 删除包含空白字符的空白行和只有一个换行符的空行

## 删除只有一个换行符的空行
在 vim 中，可以使用 `:%g/^$/d` 命令来删除只有一个换行符的空行。这里的 `^` 表示匹配行首，`$` 表示匹配行末，在行首和行末之间没有任何字符，也就是空行。严格来说，这里说的“行末”指的是最后一个换行符前面的一个字符，不包括换行符自身。“空行” 实际上还是包含有一个换行符。

假设文件中有如下的内容：
```vim
abcd

efg

hijk

lmn


opqrst
```
那么执行 `:%g/^$/d` 命令后的内容如下：
```vim
abcd
efg
hijk
lmn
opqrst
```
可以看到，中间的空行都被删除了。

## 删除包含空白字符的空白行，但不删除只有一个换行符的空行
有一些空白行看起来没有内容，但可能会包含空格、Tab字符等空白字符，这些行用 `:%g/^$/d` 命令无法删除，`^$` 匹配不到包含空白字符的情况。

可以用 `:%g/^\s\+$/d` 命令来删除这些空白行，但不删除只有一个换行符的空行。

这里的 `\s` 表示匹配一个空白字符，`\+` 表示匹配一个或连续多个跟在它前面的上一个字符，`\s\+` 至少匹配一个空白字符，换行符不属于空白字符，所以不匹配只有一个换行符的情况。

## 删除包含空白字符的空白行和只有一个换行符的空行
可以使用 `:%g/^\s*$/d` 命令来同时删除包含空白字符的空白行和只有一个换行符的空行。

这里的 `*` 表示匹配零个或连续多个跟在它前面的上一个字符。对 `^\s*$` 模式来说，匹配零个空白字符的情况，就相当于 `^$` 模式，也就是匹配只有一个换行符的空行，所以这个命令可以删除只有一个换行符的空行。

# 在vim中用 y 命令复制
在 vim 中，可以使用 `y` 命令进行复制，输入该命令之后，还需要再输入一个 *motion* 操作符来指定要复制字符、单词、还是行，具体说明如下：
- yw  
复制一个单词 (包括单词后面的空白字符)
- ye  
复制一个单词 (不包括单词后面的空白字符)
- yl  
复制当前光标下的字符
- yh  
复制光标前面的一个字符
- 4yl  
复制当前光标下的字符、以及后面三个字符，总共四个字符
- 4yh  
复制光标前面的四个字符 (不包括当前光标所在的字符)
- yy  
复制当前光标所在的一整行
- 4yy  
复制当前光标所在的行、以及后面三行，总共四行

另外，如果需要复制较多内容，也可以输入 `v` 命令，切换到可视模式，移动光标选中一块区域，再输入 `y` 命令就能复制选中的所有内容。

用 `y` 命令复制之后，可以用 `p` 命令粘贴所复制的内容。

# 一次性关闭所有文件
使用 vim 同时打开多个文件 buffer、或者打开多个窗口文件时，如果文件改动都已经保存，可以使用 `:qall` 命令来一次性关闭所有文件，直接退出 vim。该命令可简写为 `:qa`。

如果部分文件改动还没有保存，且想要丢弃文件改动，可以使用 `:qa!` 命令。

查看 `:help qa` 的说明如下：
> **:qa[ll]**  
Exit Vim, unless there are some buffers which have been changed.

# 用vim打开文件时自动跳转到文件末尾
在 vim 中，可以用下面命令指定打开文件后，自动跳转到哪一行：
```vim
vim +[num] filename
```
这个命令会在打开 *filename* 文件时，光标自动跳转到 *num* 行。这个 *num* 是可选值。如果没有提供该参数，只写为 `+` 时，则自动跳转到文件末尾。

即，`vim + filename` 命令在打开 *filename* 文件时，光标会自动跳转到文件末尾。

查看 man vim 的说明如下：
> **+[num]**  
For the first file the cursor will be positioned on line "num".  If "num" is missing, the cursor will be positioned on the last line

在实际使用时，也可以先写文件名，再写 `+[num]`。例如，`vim filename +4` 命令会在打开 *filename* 文件时，自动跳转到第 4 行。

# 在程序代码中快速跳转
在 vim 中查看代码文件时，可以使用下面命令在程序代码中快速跳转，提高效率。
- %  
跳转到光标所在括号的另一个配对括号上，适用于小括号`()`、大括号`{}`、方括号`[]`。  
例如当前光标在左大括号 `{` 上，输入 `%` 命令，光标会跳转到配对的右大括号 `}` 上。  
这个命令也适用于C语言的条件编译宏，可以在配对的 `#if`、`#ifdef`、`#else`、`#elif`、` #endif` 之间快速跳转光标。
- [m  
跳转到当前光标往上的最近一个函数开头，停在左大括号上。  
如果光标在函数内，就是跳转到当前函数的开头左大括号。  
如果光标在函数外，则跳转到上面最近一个函数的开头左大括号。
- [M  
跳转到当前光标往上的最近一个函数结尾，停在右大括号上。  
无论当前光标在函数内、还是函数外，都是跳转到上面最近一个函数的末尾右大括号。
- ]m  
跳转到当前光标往下的最近一个函数开头，停在左大括号上。  
无论当前光标在函数内、还是函数外，都是跳转到下面最近一个函数的开头左大括号。
- ]M  
跳转到当前光标往下的最近一个函数结尾，停在右大括号上。  
如果光标在函数内，就是跳转到当前函数的末尾右大括号。  
如果光标在函数外，则跳转到下面最近一个函数的末尾右大括号。
- [{  
跳转到当前光标往上最近一个没有匹配的左大括号，停在左大括号上。  
例如光标在 `if` 语句内，则跳转到 `if` 语句开头左大括号。
- ]}  
跳转到当前光标往下最近一个没有匹配的右大括号，停在右大括号上。  
例如光标在 `if` 语句内，则跳转到 `if` 语句末尾右大括号。
- [(  
跳转到当前光标前面最近一个没有匹配的左小括号，停在左小括号上。  
例如光标在一个小括号 `()` 内，则跳转到左边最近的左小括号。
- ])
跳转到当前光标后面最近一个没有匹配的右小括号，停在右小括号上。  
例如光标在一个小括号 `()` 内，则跳转到右边最近的右小括号。

这些命令都可以在前面加上数字,表示跳转级数. 例如:
- 3[m  
将跳转到当前光标往上的第三个函数开始处，停在左大括号上。  
如果光标在函数内，则当前函数是第一个函数，会再往上跳两个函数。
- 3[{  
将跳转到当前光标往上的第三级大括号开始处，停在左大括号上。

可以使用 `:help [(` 命令查看 `[(` 的说明。`%` 的说明在 `[(` 的上面。  
可以使用 `:help [m` 命令查看 `[m` 的说明。  
其他命令的说明可以类似查看。

# 使用vim将文件转出html格式
在 vim 中，可以使用 `:TOhtml` 命令来将当前文件转换出 html 格式文件。注意这个命令的大小写，不能写为 `:tohtml` 的形式。

`:TOhtml` 命令基于整个文件内容转成一个新的 html 文件，拆分新的 vim 水平窗口显示转换后的 html 文件内容。如有需要，可以自行修改文件内容做一些调整。最后，保存该 html 文件即可。

**注意**：这个 html 文件需要在 vim 中保存后才会生成本地文件，`:TOhtml` 命令并没有直接生成本地的 html 文件，也不会修改原有文件本身的内容，而是生成新的 html 文件。

如果只是需要转某几行代码（例如30行到42行），则执行 `:30,42TOhtml` 命令。

如果当前 vim 配置成显示行号，所转换出来的 html 文件中也会带有行号。不想带有行号的话，可以在转换之前，先执行 `:set nonu` 命令设置为不显示行号。

# 去掉搜索内容的高亮
vim 打开搜索高亮 (set hlsearch) 后，搜索到的内容会一直高亮显示。

如果要去掉搜索内容的高亮，可以搜索一些不存在的内容，搜索不到就会去掉之前的高亮。  

上面是取巧的做法，标准做法是执行 `:nohlsearch` 命令。  
这个命令会去掉搜索内容的高亮，但还是打开搜索高亮功能，下次搜索到内容还是会高亮。

为了方便执行，可以在 `~/.vimrc` 文件中，把这个命令映射成快捷键。下面把它映射为 F9 键：
```vim
" 如果要去掉高亮显示搜索到的内容,需要再次搜索一些不存在的字符串,比较麻烦.可以
" 在vim的命令行中执行nohlsearch命令去掉当前高亮.下面以:开头表示在命令行执行.
nnoremap <F9> :nohlsearch<CR>
" 插入模式下也用F9来去掉搜索高亮.下面的<C-o>表示CTRL-O,在插入模式执行一次命令
inoremap <F9> <C-o>:nohlsearch<CR>
```

# 用列表形式显示所有搜索到的内容
vim 在文件内用 `/` 或者 `?` 进行查找，不会列出所有查找到的内容，需要通过 n 或者 N 命令逐一跳转到匹配的位置。

如果想要用列表的形式显示所有查找到的内容，可以用 `[I` 命令。注意，`[` 后面跟着的是大写字母`I`。该命令在查找 *count_matches* 单词时，会显示类似于下面的效果：
```vim
src/main.c
  1:  586 static int count_matches;
  2: 1270       if (count_matches)
  3: 1879         count_matches = 1;
  4: 2093       count_matches = 0;
Press ENTER or type command to continue
```
可以看到，使用 `[I` 命令，一次性列出了包含搜索内容的所有行，第二列是对应行的行号。之后，可以在命令行输入 `:number` 跳转到 *number* 对应的行。例如，输入 `:1879`，回车后会跳转到 1879 行。

`[I` 表示从文件开头开始查找当前光标下的关键字，如果当前光标不在要搜索的关键字下，可以先用 `/` 或者 `?` 搜索，跳转到关键字后，再用 `[I` 命令。

如果当前文件是 C/C++ 代码文件，`[I` 也会查找 `#include` 指定的头文件。即可能会列出多个文件下的匹配内容。如果不想要这个效果，可以先执行 `:set include=` 命令，将include选项的值设成空，就不会查找include的头文件，然后再执行 `[I` 命令，查找完后执行 `:set include&` 命令重置include选项为默认值。
可以映射快捷键把这三个命令放到一起，方便操作。 例如下面映射为 F7 键：
```vim
:map <F7> :set include=<CR>[I:set include&<CR>
```
如果不是 C/C++ 代码文件，不需要做其他设置，`[I` 命令只会查找当前文件。

**注意**：`[I` 命令不能查找少数的特殊字符，例如不能查找右大括号`}`，但是可以查找左大括号`{`。

# 在不同文件buffer间切换
用 `vim file1.txt file2.txt ...` 命令同时打开多个文件，或者在 vim 里面用 `:edit` 命令再打开其他文件时，会有多个文件buffer，可以不用退出 vim 就同时编辑多个文件。

可以用下面命令在不同文件buffer间切换：
- `:bn`  
切换到下一个文件
- `:bp`  
切换到上一个文件
- `:ls`  
打印文件buffer的列表，带编号
- `:b [N]`  
切换到第N个文件，例如 `:b 3` 命令切换到第3个文件。文件编号可以用 `ls` 命令查看
- `:b {bufname}`  
通过文件名切换到 bufname 对应的文件，输入文件名时，可以用Tab键补全。

使用Tab键补全时，每按一次Tab键，就会补全一项。如果不小心跳过了想要打开的文件名，可以用 CTRL-P 键返回到前面的项。

可以用 `:help :buffer` 命令查看这部分的完整帮助说明。

# 查看某个配置项的值、以及它在哪里被设置
vim 使用 `:set` 命令设置配置项的值，但是没有 `:get` 命令来查看配置项的值。要查看配置项的值，也是用 `:set` 命令，在配置项名称后面加上 ‘?’ 即可。

即，用 `:set option?` 命令查看 option 配置项的值。例如，执行 `:set shiftwidth?` 命令，会打印 *shiftwidth=4* ，显示出该选项的值。

用 `:verbose set option?` 命令查看 option 配置项的值最终是在哪里被设置。例如，执行 `:verbose set shiftwidth?` 命令，就能看到哪个文件设置了这一项，类似于下面的打印：
```vim
  shiftwidth=4
      Last set from ~/.vimrc line 68
```
如果想查看所有被修改过的配置项值，可以直接执行 `:set` 命令，这个命令会列出所有跟 vim 源码默认值不同的配置项值。

可以用 `:set option&` 重置 option 配置项的值为源码默认值。注意不是恢复成 vimrc、或其他vim配置文件所设置的值。

vim 有一类配置项控制功能开关，只有开或者关两个值，这类选项可以用 `:set option!` 命令来切换选项的值。当前打开，则切换后关闭；当前关闭，则切换后打开。例如，`:set nu!` 命令切换是否显示行号。

这个方法可以用于映射快捷键动态开关某个选项值，只需要映射一个快捷键。例如，`:map <F8> :set hlsearch!<CR>` 命令映射 F8 键来动态开关搜索高亮功能。

可以用 `:help :set` 命令查看更多的帮助说明。

对于开关类选项来说，`:set option` 表示打开这个配置项。用 `:set option?` 命令查询这类配置的值，如果漏打 `?` 的话就会变成设置命令，会造成误操作。

为了避免出现误操作，可以用 `:echo &option` 命令来查看配置的值。`&option` 是 vim 的表达式，表示获取 option 项的值（用 `:help expr-option` 命令查看它的帮助说明），然后用 `:echo` 命令打印这个值。

# Backspace键不能删除字符或者时灵时不灵
在 vim 中要正常使用 Backspace 键删除字符，需要正确设置 *backspace* 选项的值。
```vim
:set nocompatible
:set backspace=indent,eol,start
```
在 compatible 模式下，设置 *backspace=indent,eol,start* 也能工作，但是被删除的字符不会立刻显示为空白，显示效果不好。

为了兼容 vim 5.4 版本和之前版本，`:set backspace=2` 相当于 `:set backspace=indent,eol,start`。

对 *backspace=indent,eol,start* 设置项的参数说明如下：
- indent  
允许删除自动缩进的内容。如果没有这一项，自动缩进添加的空白字符无法用 Backspace 键来删除，可以删除手动添加的缩进空格。
- eol  
允许删除换行符。如果没有这一项，当已经删除到行首时，不能用 Backspace 键删除换行符，也就是不能自动往上删除到上一行。
- start  
允许删除进入插入模式前已有的内容。如果没有这一项，不能删除进入插入模式前已有的内容，只能删除当前插入模式下输入的字符。例如，输入 *abc* 三个字符，按 Esc 键退出插入模式，再按 a，进入插入模式，输入 *efg*。此时 Backspace 键可以删除 *efg*，不能删除 *abc*。

在Debian或Ubuntu发行版本上，不需要在 `~/.vimrc` 中自行配置 *backspace* 选项，Backspace 键就能正常使用。原因是系统自带的vim版本会加载一个 debian.vim 文件，默认已经设置这一项。可以用 `:verbose set backspace?` 命令来查看 *backspace* 选项的值、以及它被哪个地方设置。

如果使用自己源码编译的 vim 版本，并自行配置 `~/.vimrc` 文件，可能默认就没有配置 *backspace* 选项，导致 Backspace 键用不了，或者时灵时不灵。此时需要在 `~/.vimrc` 文件中主动配置 *backspace* 选项的值为*indent,eol,start*。

用 `:help 'backspace'` 命令查看该选项的帮助说明。

# 自动输入指定个数的重复字符
在编辑的时候，有时候需要输入一长串的重复字符。例如，`########`、`========`、`//////`、`*********`、`-------` 等。

为了对齐美观，可能会希望每一行这些重复字符的个数都相同。我们可以通过复制来做到这一点，但需要先找到已经写好的行，复制，再拷贝，比较麻烦。

有一个比较简单的方法是，在输入的时候，就指定要重复的字符个数，然后只输入一个字符，接着退出插入模式，vim 会自动输入指定个数的重复字符。

例如，在普通模式下，输入 `10a=` 就能得到 10 个连续的 ‘=’ 字符。按 `a` 后，会进入插入模式，然后只输入一个 `=` 字符，再按 Esc 键，vim 会自动输入9个 `=` 字符，得到10个连续的 `=` 字符。

这里的 `a` 可以换成其他进入插入模式的命令，例如 `i` 命令，也不限于插入单个字符。实际上，进入插入模式后输入的所有内容，都会在退出插入模式时被重复输入。

用 `:help count` 命令可以看到在命令前面输入数字重复执行命令的帮助说明。

# 在文件内跳转到变量定义处
在当前文件内，可以使用下面命令来快速跳转到变量定义处。
- **gd**  
在当前函数内查找当前光标下的单词，如果找到，就跳转到该单词在函数内第一次出现的地方。  
对局部变量来说，也就是跳转到变量定义处。  
如果光标下的单词对应全局变量，这个命令不会跳转到全局变量定义处，而是会跳转到函数内第一次用到该变量的地方。  
这个命令本身没有进行语法解析，只是简单的执行字符串搜索并跳转。在实际使用时可用来查找任意单词，不限于查找变量。
- **gD**  
在当前文件内查找当前光标下的单词，如果找到，就跳转到该单词在文件内第一次出现的地方。  
对全局变量来说，也就是跳转到全局变量定义处。  
对局部变量来说，也能跳转到局部变量定义处。  
如果变量是在文件外定义，就只能跳转到当前文件内第一次用到该变量的地方。

实际测试，gd 命令只能在函数内搜索，不会跳转到全局变量定义处。gD 命令是在整个文件内搜索，可以跳转到全局变量定义处，也能跳转到函数内的局部变量定义处。

**如果不确认要搜索的单词是全局变量，还是局部变量，统一用 gD 命令即可。如果变量是在当前文件内定义，gD 命令一定能跳转到文件内的变量定义处，比 gd 命令要方便**。

可以用 `:help gd` 和 `:help gD` 命令来查看帮助说明，这两个命令的帮助说明是相邻的。

# 增加或减少缩进
vim可以用 `=` 命令对代码文件自动格式化对齐。具体用法说明如下：
- `==`  
对光标所在行进行自动格式化对齐，会根据代码情况增加或减少缩进。可以在 `==` 前面加上数字，指定要同时处理多少行。例如，`4==` 会格式化对齐当前行、以及后面的三行。
- `gg=G`  
对整个文件都重新格式化对齐。
- `={motion}`  
自动格式化 {motion} 操作前后的行。{motion} 可以是 vim 里面任意移动光标的操作。例如常见的 j、k、G、% 等。`%` 用于移动光标到匹配的括号上。当光标在 `{` 或者 `}`上时，`=%` 会格式化整个{}括起来的内容，包括 `{}` 自身。

下面的 `a{`、`i{` 也是 {motion} 的一种：
- `=a{`  
当光标所在行位于{}花括号内时，自动格式化对齐整个{}里面的内容，包括 `{}` 这两个花括号所在的行也会一起格式化，以 `{` 的上一行为基准来对齐。如果 `{` 自身的对齐错乱了，可以把 `{` 所在的行也一起对齐。
- `=i{`  
当光标所在行位于{}花括号内时，自动格式化对齐整个{}里面的内容，不包括 `{}` 这两个花括号所在的行，以 `{` 所在的行为基准来进行对齐。如果 `{` 自身所在行的对齐错乱，不会把 `{` 所在的行也一起对齐。

用 `=` 命令自动格式化，默认使用C语言的对齐风格。如果不喜欢这种风格，也可以手动增加或减少缩进来对齐。下面几个命令可以用于手动缩进：
- `>>`  
把光标所在行向右增加缩进，缩进空格数由 shiftwidth 选项指定。
- `>{motion}`  
对 {motion} 操作前后的行向右增加缩进。缩进空格数由 shiftwidth 选项指定。{motion} 可以是 vim 里面任意移动光标的操作。
- `<<`  
把光标所在行向左减少缩进，缩进空格数由 shiftwidth 选项指定。
- `<{motion}`  
对 {motion} 操作前后的行向左减少缩进。缩进空格数由 shiftwidth 选项指定。{motion} 可以是 vim 里面任意移动光标的操作。

下面的 `a{`、`i{` 也是 {motion} 的一种，可以用于 `>` 或者 `<` 命令。
- `>a{`  
当光标所在行位于{}花括号内时，将整个{}里面的内容向右增加缩进，包括 `{}` 这两个花括号所在的行也会一起缩进。
- `>i{`  
当光标所在行位于{}花括号内时，将整个{}里面的内容向右增加缩进，不包括 `{}` 这两个花括号所在的行，它们自身的行不会被缩进。

用 `:help =` 命令查看 `=` 的帮助说明。  
用 `:help <` 和 查看 `<` 和 `>` 的帮助说明，这两个命令的说明是相邻的。  
用 `:help motion.txt` 命令查看有哪些 {motion} 操作可以移动光标。  
用 `:help usr_30.txt` 查看 `=`、`>` 命令在对齐方面的举例说明。

# 在多窗口间跳转和改变窗口大小
vim 可以用 `:sp` 命令打开一个新的水平切分窗口，在不同的窗口显示各自的内容。  
用 `:vsplit` 命令则是打开一个新的垂直切分窗口。

显示多窗口后，可以用下面几个方式在不同窗口之间跳转，以便选择操作哪个窗口：
- `CTRL-W j`  
光标切换到下一个窗口。
- `CTRL-W k`  
光标切换到上一个窗口。
- `CTRL-W h`  
光标切换到左边窗口。如果左边没有窗口，保持在当前窗口不变。
- `CTRL-W l`  
光标切换到右边窗口。
- `CTRL-W w`  
在各个窗口之间来回切换。每输入一次，切换一个窗口。不停输入，可以遍历所有窗口。在只有两个窗口时很方便来回切换。

这些键位的输入方式是，同时按住 CTRL 键和 w 键 (小写的w，不需要按Shift键)，然后松开，再按下一个键，例如 j 键、w 键 等。不松开 CTRL-W，直接按下一个键也可以。

上面的 k/j/h/l 键可以换成键盘的上下左右光标键。

可以执行 `:q` 命令退出且只退出当前窗口。如果当前只有一个窗口，会退出vim。  
`CTRL-W q` 命令跟 `:q` 效果相同。  
`CTRL-W c` 命令也可以退出当前窗口。如果当前只有一个窗口，会报错，不退出vim。  
`:close` 命令跟 `CTRL-W c` 效果相同。

有一些 vim 插件会弹出 quickfix 窗口，这些命令也可以用来在这些窗口之间跳转。

可以用下面命令来改变窗口大小：
- `CTRL-W +`  
当前窗口增加一行。在按 CTRL-W 之前，可以先输入数字指定要增加多少行。按键方式是先同时按 CTRL 和 w，然后松开，再输入 +。  
增加当前窗口行数，其他窗口会减少行数，最多可以减小到只有一行。
- `CTRL-W -`  
当前窗口减少一行。同样可以先输入数字指定要减少多少行。
- `CTRL-W _`  
最大化当前窗口，其他窗口会缩小到只有一行。这里的 `_` 要按 Shift 键来输入。

用 `:help windows.txt` 命令查看完整的帮助说明。

# 使用session保存会话
Vim 的 session 类似于 Source Insight 的工程，也可以类比为其他IDE的工程。使用 session 可以可以保存打开的文件列表、窗口大小、当前选项设置等信息。

结合 viminfo 一起使用，可以保存命令历史、标记信息、寄存器信息等。

在编辑、或者查看多个文件时，可以用这个机制保存vim状态，下次打开vim可以重新恢复到之前的状态，自动打开多个文件，不用再手动逐个打开想要查看的文件。

用 `:mksession [file] ` 命令保存当前 session 到一个 vim 脚本文件里面。 `[file]` 是可选参数，指定要保存的文件名。如果没有提供，默认名是 *Session.vim*。

用 `:source {file}` 加载 `{file}` 指定的 vim 脚本文件。如果传入的是之前保存的 session 脚本文件名，就会恢复到指定的session。`{file}` 是必选参数，必须提供。

也可以用 `vim -S filename` 命令在打开 vim 时就加载指定的脚本文件，恢复到该脚本文件保存的状态。例如之前打开了多个文件，此时会自动打开这些文件。

用 `:help :mksession` 命令查看保存 session 的帮助说明。  
用 `:help :source` 命令查看该命令的帮助说明。

# gtags 插件指定忽略的目录或文件
vim 可以集成 gtags 插件来查看函数定义和调用关系。在用 gtags 解析源代码时，如果想要指定忽略某些目录，可以在要解析的目录下创建 *gtags.conf* 文件，然后在这个文件里面配置 gtags 解析时要忽略的目录，参考格式如下:
```make
default:\
        :skip=src/,lib/
```
在 `:skip=` 后面跟着要忽略的目录路径，不同目录之间用逗号(,)隔开。这里不仅可以指定目录，也可以指定文件名，或者通过通配符指定特定类型的文件。

在不加其他命令选项的情况下， *gtags.conf* 文件一定要包含一个 `default:` 开头的项,它默认就是从这一项开始处理。这会覆盖默认的 skip 配置，可以用 `gtags --config skip` 来查看当前 skip 的值。

# 设置空格和Tab字符可见，并自定义显示的字符颜色
使用 Windows 下的一些 IDE（例如 Source Insight）查看代码时，可以设置空格和Tab字符可见。本篇文章介绍在 vim 中如何进行这个设置，并自定义显示的字符颜色。具体包括下面的内容：
- 设置空格和Tab字符可见的好处
- 设置空格和Tab字符可见
- 设置空格和Tab字符的显示颜色
- 只针对特定类型文件自动设置空格和 tab 字符可见

## 设置空格和Tab字符可见的好处
在实际工作中，设置空格和Tab字符可见，主要是基于下面的需求：
- 由于 tab 字符在不同编辑器下的显示宽度可能不同，在代码中使用 tab 字符进行缩进，在其他地方查看时，排版缩进会发生变化。一些公司的编程规范要求不能使用 tab 字符。设置 tab 字符可见，可以发现哪里用了 tab 字符，便于删除。
- 一些公司使用 git 管理代码，并上传到 gerrit 服务器上。如果上传的代码包含 tab 字符，在 gerrit 上审核代码会把 tab 字符显示成红色，也是不建议用 tab 字符，所以需要设置 tab 字符可见，方便在上传代码之前就发现、并删掉 tab 字符。
- 在 git 上用 git log -p 命令查看代码修改前后时，行末空格会显示红色的警告。为了不看到这个警告，需要设置空格可见，发现行末空格，以便及时删除。

## 设置空格和Tab字符可见
在 vim 中，可以使用下面命令来设置空格和 tab 字符可见：
```vim
:setlocal list
:set listchars=tab:>~,trail:.
```

执行 `:setlocal list` 命令后，会把 tab 字符显示为 CTRL-I 键的显示字符，实际显示为 `^I`。同时会在行末显示一个 `$` 字符。默认不会显示空格。

这个 *list* 选项是一个 “local to window“ 选项，也就是可以使用 `:setlocal` 命令来设置成只在当前窗口生效，这样设置之后，用 `:edit` 命令再打开其他文件，在新的窗口上没有开启这个设置，不会影响其他文件。

如果想要在打开代码文件时，才显示空格或 tab 字符，打开其他类型文件，例如 txt 文件、markdown 文件、makefile 文件等，不显示空格或 tab 字符，就可以使用 `:setlocal list` 命令。如果需要设置成全局状态，所有窗口都开启这个设置，可以使用 `:set list` 命令。

由于把 tab 字符显示为 `^I` 不够直观，不想在行末显示 `$` 字符，且需要显示空格，所以再执行 `set listchars=tab:>~,trail:.` 命令来设置 tab 字符和空格的显示样式，且行末不显示字符。

这个 *listchars* 选项是一个 “global” 选项，一旦设置，对所有窗口都生效，用于设置 *list* 属性会显示哪些字符、以及如何显示。常见的选项值说明如下：
- **eol:c**  
设置行末显示字符为 *c*。这里 *c* 可以换成任意一个字符，例如默认的 `$` 字符、或者改成 `#` 字符，等等。  
显然，要设置成一个可见字符，才能明显地看到显示效果。  
如果没有设置这一项，行末不显示任何字符。
- **tab:xy**  
设置 tab 字符的显示样式，字符 *x* 总是会显示，会显示零个或多个字符 *y* 以填充到 tab 字符的显示宽度。  
例如，设置为 `tab:>-`，且 tab 字符的显示宽度是 4，那么 tab 字符会显示为 `>---`。  
实际显示的时候，可能只显示一个 `>`，或者只显示 `>-`。这个跟 tab 字符所在的位置有关。假设 tab 字符的显示宽度为 4，意味着 tab 字符的宽度总是停在 4 的倍数行上，当手动输入 3 个空格，再输入一个 tab 字符时，tab 字符只会显示一个空白字符，那么就只显示所设置的字符 *x*，对于刚才的例子来说，就是只显示 `>` 字符。  
在实际测试时，如有设置 `:set expandtab`，会把 tab 字符转换成空格，输入 tab 键不会得到 tab 字符，要先执行 `:set noexpandtab` 命令，关闭这个设置再来测试。
- **tab:xyz**  
设置 tab 字符的显示样式，字符 *z* 总是会显示，显示字符 *z* 之后，如果还有可显示的位置，字符 *x* 会显示在开头，在字符 *x* 和 字符 *z* 中间显示零个或多个字符 *y* 以填充到 tab 字符的显示宽度。  
例如，设置为 `tab:<->`，且 tab 字符的显示为 4，那么 tab 字符会显示为 `<-->`。  
实际显示的时候，可能只显示一个 `>`，或者显示为 `<>`、`<->` 等，跟 tab 字符所在的位置有关。如上面说明所示。
- 如果没有设置 **tab:** 这一项，tab 字符默认会显示为 `^I`。
- **space:c**  
设置所有的空格显示为字符 *c*，包括行首空格、行中间的空格、行末空格都会显示。  
这里 *c* 可以换成任意一个字符。  
如果没有设置这一项，空格显示为默认的空白。
- **trail:c**  
设置行末空格显示为字符 *c*，会覆盖 `space:` 这一项的设置，且只覆盖行末空格的显示。  
这里 *c* 可以换成任意一个字符。  
如果没有设置这一项，行末空格保持为 `space:` 这一项的设置。
- 不同设置项之间，用英文逗号 `,` 隔开。例如，`tab:>~,trail:.` 设置了 tab 字符和行末空格的显示样式。

基于上面说明，可以知道 `set listchars=tab:>~,trail:.` 命令设置 tab 字符显示为 `>~~~~` 的样式（假设 tab 字符的显示宽度是 4），设置行末空格显示为点号 `.`，不显示行首空格和行中间的空格，行末不显示字符。如果需要显示所有空格，可以把 *trail* 改成 *space*。

## 设置空格和Tab字符的显示颜色
进行前面的设置之后，空格和 tab 字符已经可见，但是显示的字符颜色使用了 `hi SpecialKey` 这一项的颜色，可以执行 `:hi` 命令查看 *SpecialKey* 对应的颜色是什么，跟 vim 使用的颜色主题有关，不同颜色主题可能有不同的颜色，例如蓝色、绿色、黑底白色等。

这个显示颜色会跟代码文件本身的颜色高亮混在一起，不方便区分。假设 tab 字符显示为 `>~~~~`，字符颜色是蓝色，如果后面跟着蓝色的代码关键字，就跟代码关键字显示成一个整体，不方便看到代码关键字。前面把行末空格显示为点号 `.`，如果某句注释的行末有空格，容易误以为是注释本身的点号。

为了方便区分于代码文件自身的颜色高亮，可以使用下面命令来设置可见的空格和 tab 字符显示为灰色，不那么显眼，方便区分于代码文件自身的颜色高亮：
```vim
:hi SpecialKey guifg=darkgrey ctermfg=darkgrey
```

如果不想显示成灰色，可以修改上面 *guifg*、*ctermfg* 的值，设置成个人喜欢的颜色。

这样设置之后，会有一个问题，就是修改了默认 `hi SpecialKey` 这一项的颜色。而 vim 会用到这个颜色来显示自身的一些内容，例如执行 `:map` 命令，显示映射的快捷键时，按键字符就显示为 `hi SpecialKey` 这一项的颜色，改成灰色后，不太显眼。

为了避免直接修改 `hi SpecialKey` 这一项的颜色，我们可以自定义一个颜色组，并设置为只对空格和 tab 字符生效，具体如下所示：
```vim
:highlight MyTabSpace guifg=darkgrey ctermfg=darkgrey
:match MyTabSpace /\t\| /
```
这里用 `:highlight` 命令（这个命令也可以简写为 `:hi` 命令）来自定义了一个 *MyTabSpace* 颜色组，显示为灰色。然后用 `:match` 命令设置 *MyTabSpace* 颜色组对空格和 tab 字符生效。上面的 `\t` 就是 tab 字符。不同字符串之间用 `|` 隔开，书写的时候要使用 `\|` 转义。在 `|` 后面的空白字符就是空格。

## 只针对特定类型文件自动开启空格和 tab 字符可见
如前面说明，我们可能只想在查看代码文件时，才设置空格和 tab 字符可见，并且最好是自动开启。这个就需要在 `~/.vimrc` 文件中进行配置。完整配置如下：
```vim
" 创建一个新的 MyTabSpace 组,并设置它的颜色
highlight MyTabSpace guifg=darkgrey ctermfg=darkgrey
" 指定tab字符和空格的颜色组为MyTabSpace,不同字符串之间用|隔开,要使用\|转义.
match MyTabSpace /\t\| /
" 针对特定类型的代码文件,设置显示Tab键和行尾空格以便在查看代码时注意到它们
autocmd FileType c,cpp,java,xml setlocal list | set listchars=tab:>~,trail:.
```
这段配置先使用 `:highlight` 命令（在 *.vimrc* 文件中书写时，省略了前面的冒号）自定义一个 *MyTabSpace* 颜色组，颜色为灰色。然后用 `:match` 命令设置 *MyTabSpace* 颜色组对空格和 tab 字符生效。由于空格和 tab 字符默认不可见，所以对于没有设置空格和 tab 字符可见的文件窗口来说，这个设置没有影响。

后面使用 `:autocmd` 命令针对 `c,cpp,java,xml` 这些类型的文件自动设置空格和tab 字符可见，就能看到这些字符显示为灰色。其他类型文件没有自动设置，不受影响。如有需要，可以自行添加其他类型的文件后缀名。

可以使用 `:help 'list'` 命令查看 `list` 选项的说明。  
可以使用 `:help 'listchars'` 命令查看 `listchars` 选项的说明。  
可以使用 `:help :highlight` 命令查看设置颜色高亮的更多说明。  
可以使用 `:help :match` 命令查看如何设置指定字符串的显示颜色组。  
可以使用 `:help :autocmd` 命令查看如何针对特定类型文件自动执行指定命令。

# 详解 tabstop、softtabstop、expandtab 三个选项的区别
在 vim 中，tab 字符默认的显示宽度是 8 个空格。在终端打开 vim，多按几次 Tab 键，很容易就超出终端的显示宽度。为了良好的编码体验，需要调整 tab 字符的显示宽度。如果不想插入 tab 字符，还需要把 tab 字符替换成空格。可以通过配置 *tabstop* 选项、*softtabstop* 选项、*expandtab* 选项来修改 tab 字符的显示和按 Tab 键的行为：
- *tabstop* 选项只修改 tab 字符的显示宽度，不修改按 Tab 键的行为
- *softtabstop* 选项修改按 Tab 键的行为，不修改 tab 字符的显示宽度。具体行为跟 *tabstop* 选项值有关
- *expandtab* 选项把插入的 tab 字符替换成特定数目的空格。具体空格数目跟 *tabstop* 选项值有关

## tabstop 选项
在 vim 中，使用 `:help tabstop` 命令查看 *tabstop* 选项的说明如下：
> 'tabstop' 'ts'          number  (default 8)  
Number of spaces that a \<Tab\> in the file counts for.  
Note: Setting 'tabstop' to any other value than 8 can make your file appear wrong in many places (e.g., when printing it).

即，*tabstop* 选项设置 tab 字符的显示宽度为多少个空格，默认值是 8。可以使用下面命令修改这个选项值为 4：
```vim
:set tabstop=4
```
*tabstop* 选项可以简写为 *ts*，`:set tabstop=4` 命令和 `:set ts=4` 命令是等效的。

上面说明提到，如果设置 *tabstop* 选项为 8 之外的值，可能会使文件在许多地方（例如，在打印时）显示错误。例如，设置 *tabstop* 选项值为 4，在 vim 中使用 tab 字符进行列对齐，看起来排版正常，保存文件。但是在其他显示 tab 字符为 8 个空格的软件上查看这个文件，原本对齐的列可能就会错乱，没对齐。

在 vim 帮助文档的各个小节中，如 `:help usr_30` 的 *Tabs and spaces* 小节、`:help usr_25` 的 *Indents and tabs* 小节，都多次建议要保持 *tabstop* 选项值为 8 不变。

在 `:help tabstop` 命令的说明中，只有设置了 *expandtab* 选项，把 tab 字符替换为空格的情况下，才建议修改 *tabstop* 选项为其他值。此时，在 vim 的插入模式下，按下 Tab 键，插入的是空格，而不是 tab 字符，保存文件后，用其他软件打开这个文件，看不到 tab 字符，自然不会因为 tab 字符的显示宽度不同而导致排版异常。

**注意**：*tabstop* 选项只修改 tab 字符在 vim 中的显示宽度，不修改插入模式下按 Tab 键，vim 插入的是 tab 字符，还是插入特定数目的空格。

## softtabstop 选项
在 vim 中，使用 `:help softtabstop` 命令查看 *softtabstop* 选项的说明如下：
> 'softtabstop' 'sts'     number  (default 0)  
Number of spaces that a \<Tab\> counts for while performing editing operations, like inserting a \<Tab\> or using \<BS\>.  It "feels" like \<Tab\>s are being inserted, while in fact a mix of spaces and \<Tab\>s is used.  
When 'sts' is zero, this feature is off.  
When 'sts' is negative, the value of 'shiftwidth' is used.

即，*softtabstop* 选项（可以简写为 *sts*）会影响 vim 在插入模式下按 Tab 键所实际得到的字符，可能是插入特定数目的空格，也可能是插入一个 tab 字符。具体使用时，会受到 *tabstop* 选项和 *expandtab* 选项的影响。可以使用下面命令修改这个选项值为 4：
```vim
:set softtabstop=4
```
设置之后，在 *tabstop* 选项值为 8，且没有设置 *expandtab* 选项的情况下，第一次按 Tab 键，vim 会插入 4 个空格，而不是插入一个 tab 字符。之后，第二次按 Tab 键，vim 会删除前面的 4 个空格，然后插入一个 tab 字符。由于 *tabstop* 选项值是 8，界面上会看到光标继续往前移动了 4 个空白字符，像是又插入了 4 个空格，但实际上两次按 Tab 键，只插入一个 tab 字符。

从写入文件的字符和字节数来说，第一个按 Tab 键，写入 4 个空格，也就是四个字节，第二次按 Tab 键，会删掉之前写入的 4 个空格，再写入一个 tab 字符，只有一个字节，写入文件的字节数变少了。虽然从界面上看，显示了 8 个空白字符，但这只是一个 tab 字符的显示宽度。可以执行下面命令让空格和 tab 字符可见，再进行测试，就能清楚地看到这一点：
```vim
:set list
:set listchars=tab:>~,space=.
```

另外，*softtabstop* 选项也会影响 Backspace 键删除连续多个空格和删除 tab 字符的行为。在上面的场景中，第一次按 Tab 键，vim 会插入 4 个空格，此时可以用 Backspace 键一次性删除这 4 个空格。即，只按一次 Backspace 键，就能删除这 4 个空格。

当按下两次 Tab 键，插入一个 tab 字符后，按下 Backspace 键，其实是把这个 tab 字符替换成 4 个空格。从界面上看，光标往前移动了 4 个空白字符，但是文件的字节数实际上变多了。

比较特别的是，在插入模式下，手动输入 4 个空格，此时按 Backspace 键只能删除一个空格。但是手动输入 4 个空格后，退出插入模式，再进入插入模式，就能用 Backspace 键一次性删除这 4 个空格。

当 *tabstop* 选项值是 4，*softtabstop* 选项值是 4，且没有设置 *expandtab* 选项时，每次按 Tab 键，都是插入一个 tab 字符，不会再插入任何空格。如前面说明，vim 建议不要进行这样的设置，避免用 Tab 键插入 tab 字符进行对齐缩进时，在其他软件上查看文件可能会出现排版异常。

当 *softtabstop* 选项值小于 0 时，其真实值会被设置成 *shiftwidth* 选项的值。这个特性有助于保持和自动缩进的排版一致。后面会具体说明。

**注意**：*softtabstop* 选项影响 vim 在插入模式下按 Tab 键所实际得到的字符，不改变 vim 中 tab 字符的显示宽度，tab 字符始终显示为 *tabstop* 指定的宽度。当 *softtabstop* 选项值小于 *tabstop* 选项值时，第一次按 Tab 键，会插入 *softtabstop* 选项值对应的多个空格，当插入的空格个数到达 *tabstop* 指定的宽度时，会删除插入的空格，替换成一个 tab 字符。

## expandtab 选项
在 vim 中，使用 `:help expandtab` 命令查看 *expandtab* 选项的说明如下：
> 'expandtab' 'et'        boolean (default off)  
In Insert mode: Use the appropriate number of spaces to insert a \<Tab\>.  
To insert a real tab when 'expandtab' is on, use CTRL-V\<Tab\>.

即，设置 *expandtab* 选项后，在插入模式下，会把按 Tab 键所插入的 tab 字符替换为合适数目的空格。如果确实要插入 tab 字符，需要按 CTRL-V 键，再按 Tab 键。可以使用下面命令来开启这个选项：
```vim
:set expandtab
```
设置之后，会把一个 tab 字符替换成 *tabstop* 选项值对应的多个空格。例如，*tabstop* 选项值为 8，那么插入一个 tab 字符，会被替换成 8 个空格。

需要注意的是，对于 *softtabstop* 选项值为 4，*tabstop* 选项值为 8，且没有设置 *expandtab* 选项的场景来说，第一次按 Tab 键，插入的是 4 个空格，并没有插入 tab 字符，没有发生替换 tab 字符为空格的情况，并不是说设置 *softtabstop* 选项值为 4，*expandtab* 选项会基于 *softtabstop* 选项值来把 tab 字符替换成 4 个空格。当按两次 Tab 键，插入一个 tab 字符后，*expandtab* 选项还是基于 *tabstop* 选项值把 tab 字符替换成 8 个空格。

**注意**：设置 *expandtab* 选项只能把新插入的 tab 字符替换成特定数目的空格，不影响文件中已有的 tab 字符。即，文件已有的 tab 字符会保持不变。

## 配置插入 tab 字符时自动替换成空格
基于前面的说明，如果要把插入的 tab 字符自动替换成空格，可以在 `~/.vimrc` 文件中添加下面的配置：
```vim
" 自动缩进时,缩进长度为4
set shiftwidth=4
" 输入Tab字符时,自动替换成空格
set expandtab
" softtabstop的值为负数,会使用shiftwidth的值,两者保持一致,方便统一缩进.
set softtabstop=-1
```
这里没有配置 *tabstop* 选项值，保持这个值为默认的 8 不变。配置了 *expandtab* 选项，按 Tab 键所插入的 tab 字符会被替换成 8 个空格。

上面配置 *shiftwidth* 选项值为 4，该选项设置自动缩进的空格个数。同时配置 *softtabstop* 选项值为 -1，那么该选项值会等于 *shiftwidth* 选项值，也是 4，第一次按 Tab 键，会插入 4 个空格，和自动缩进的空格个数保持一致，方便统一缩进，不会出现自动缩进插入 8 个空格，而手动按 Tab 键只插入 4 个空格，缩进没有对齐的情况。

即，为了保持对齐缩进一致，手动按 Tab 键所插入的空格个数要跟自动缩进的空格个数相同，也就是 *softtabstop* 选项值要跟 *shiftwidth* 选项值相等。设置 *softtabstop* 选项值为负数就可以满足这个需求，后续如果要调整缩进的空格个数，只修改 *shiftwidth* 选项值即可。

按照 `:help tabstop` 命令的说明，设置 *expandtab* 选项后，可以修改 *tabstop* 选项值为 4，那么按 Tab 键插入 tab 字符后，也可以被替换成 4 个空格。这里没有采用这个方案，而是选择配置 *softtabstop* 选项值，目的在于配置 *softtabstop* 选项值后，可以用 Backspace 键一次性删除 4 个空格，比较方便。而且配置 *softtabstop* 选项值为负数，可以自动保持跟 *shiftwidth* 选项值一致，便于修改。

可以查看 `:help usr_30` 的 *Tabs and spaces* 小节 和 `:help usr_25` 的 *Indents and tabs* 小节来获取更多的帮助信息。

# 在插入模式下直接执行命令
在 vim 的插入模式下编辑文件，可能临时需要执行某个命令来完成一些操作，例如要跳转到第 100 行进行编辑。常见的做法是，按 Esc 键退出插入模式，执行 `100G` 命令跳转光标到第 100 行，再按 `i` 命令重新进入插入模式，开始编辑。

其实，有一个更快的方法是，在插入模式下，按 CTRL-O 键，之后就可以输入普通模式的命令，按回车执行该命令。执行命令后，还是保持在插入模式下。

**注意**：CTRL-O 键指的是同时按下 CTRL 键和小写字母 o 键，不需要按 Shift 键。

在插入模式按下 CTRL-O 键后，可以执行不带冒号的命令，例如执行 ` 100G` 命令跳转光标到第 100 行。也可以执行带冒号的命令，例如执行 `:100` 命令跳转光标到第 100 行。

具体可以查看 `:help usr_24` 的 *Normal mode commands* 小节，部分说明如下：
```
With CTRL-O {command} you can execute any Normal
mode command from Insert mode.  For example,
to delete from the cursor to the end of the line:  

        CTRL-O D

You can execute only one Normal mode command this way.
```

也可以查看 `:help i_CTRL-o` 的说明，具体描述如下：
```
CTRL-O        execute one command, return to Insert mode   *i_CTRL-O*
```
即，CTRL-O 可以在插入模式下执行一个命令，执行之后还是保持在插入模式下。

# 快速转换大小写
在 vim 中，有很多命令可以用于快速转换大小写。查看 `:help case` 的说明，就会看到所有可以转换大小写的命令。下面对常用的几个命令进行说明。

## 把大写转换成小写
使用 `gu{motion}` 命令把 `{motion}` 选中的文本转换为小写。`{motion}` 可以是 vim 任意移动光标的操作。部分操作举例说明如下。
- guw  
后面的 w 表示把光标移动到下一个单词开头。guw 会把光标下的字符、以及直到当前单词末尾的字符都转换成小写。但是光标保持不动。  
如果光标在单词开头，就是转换整个单词成小写。  
如果光标在单词前面的空白字符，不会进行转换。
- gu3w  
后面的 3w 表示把光标移动到后面第三个单词开头。gu3w 会把光标下的字符、以及直到后面第二个单词末尾的字符都转换成小写。但是光标保持不动。  
3 可以换成其他数字。后面提到的其他移动光标操作也可以加上数字来指定要重复多少次操作。
- gue  
后面的 e 表示把光标移动到下一个单词末尾。gue 会把光标下的字符、以及直到当前单词末尾的字符都转换成小写。但是光标保持不动。    
如果光标在单词开头，就是转换整个单词成小写。  
如果光标在单词前面的空白字符，也会进行转换。这是 gue 和 guw 最大的区别。
- gu$  
后面的 $ 表示把光标移动到行末。gu$ 会把光标下的字符、以及直到当前行末尾的字符都转换成小写。但是光标保持不动。  
如果光标在行首，就是转换整行成小写。

使用 `guu` 命令把光标所在行都转换成小写。

**注意**：`guu` 的最后一个 `u` 不是前面提到的 `{motion}` 操作。`gu{motion}` 执行的是 `gu` 命令，`{motion}` 是移动光标的操作。而这里的 `guu` 就是完整的命令。

使用 `v`、`V`、或者 `CTRL-V` 命令进入可视模式，选中部分内容后，输入 `u` 则把选中的内容都转换成小写。

## 把小写转换成大写
使用 `gU{motion}` 命令把 `{motion}` 选中的文本转换为大写。`{motion}` 可以是 vim 任意移动光标的操作。上面已经有部分说明。

使用 `gUU` 命令把光标所在行都转换成大写。

使用 `v`、`V`、或者 `CTRL-V` 命令进入可视模式，选中部分内容后，输入 `U` 则把选中的内容都转换成大写。

## 切换大小写
可以使用下面命令来切换大小写，也就是把大写转成小写，把小写转成大写。
- ~  
会切换光标下字符的大小写。如果光标下的字符是小写，则转换成大写。如果光标下的字符是大写，则转换成小写。光标会往前移动一个字符。
- 3～  
切换光标下的字符、以及后面两个字符的大小写。可以把 3 换成其他数字，切换指定数目字符的大小写。光标会往前移动三个字符。
- g~~  
会切换光标所在行的大小写。当前行的所有大写字符会被转换成小写，所有小写字符会被转换成大写。光标会移动行首的第一个非空白字符上。

## 总结
用列表形式总结常用的转换大小写命令如下。
| 命令 | 含义 |
| -- | -- |
| guw | 如果光标在单词开头，会转换整个单词成小写 |
| gUw | 如果光标在单词开头，会转换整个单词成大写 |
| guu | 把光标所在行都转换成小写 |
| gUU | 把光标所在行都转换成大写 |
| {Visual}u | 把可视模式选中的内容都转换成小写 |
| {Visual}U | 把可视模式选中的内容都转换成大写 |
| ~ | 切换光标下字符的大小写 |
| g~~ | 切换光标所在行的大小写 |